# 합의 메커니즘 이해하기

![consensus-thumbnail](https://github.com/bohyunkang/road-to-bangkok/assets/65386533/e63054be-d856-464e-bc07-0622a01b217d)

## 들어가며

이더리움은 분산형 플랫폼으로, 스마트 컨트랙트 및 탈중앙화 애플리케이션(DApp)을 실행하기 위해 사용된다. 이때, 네트워크의 일관성과 보안을 유지하는 합의 메커니즘은 이더리움의 핵심 요소 중 하나이다.

이번 모듈에서는 이더리움의 합의 메커니즘에 대해 설명하고, 작업 증명과 지분 증명으로의 전환 과정 등 합의 메커니즘에 관련된 내용을 다뤄보겠다.

## 합의란 무엇인가?

컴퓨터 과학에서의 합의는 분산 시스템에서 각기 다른 참여자가 한 시스템의 전체 상태에 모두 동의하도록(결과적으로) 하는 것이다. 이를 ‘합의 도달’이라고도 표현하는데, 그렇기에 합의란 일반적인 합의에 도달했음을 의미한다.

예를 들어 모임에서 영화를 보러 영화관에 갔다고 상상해보자. 무슨 영화를 볼지에 대해 의견 차이가 없으면 합의가 이루어진 것이다. 만약 의견 차이가 있는 경우, 모임은 어떤 영화를 볼 것인지 결정할 수 있는 수단을 가져야 한다. 이때 의견 차이가 좁혀지지 않는다면, 모임은 쪼개져서 영화를 볼 수도 있다.

이더리움의 경우, 프로세스가 공식화되어 있으며 합의에 도달한다는 것은 네트워크의 노드 중 최소 66%가 네트워크의 글로벌 상태에 동의한다는 것을 의미한다.

## 합의 메커니즘이란 무엇인가?

'합의 메커니즘'이라는 용어는 흔히 '지분 증명', '작업 증명' 또는 '권한 증명' 등의 프로토콜을 지칭하기 위해 구어체로 사용된다. 합의 메커니즘은 분산된 노드 네트워크가 블록체인 상태에 동의할 수 있도록 하는 프로토콜, 인센티브 및 아이디어의 전체 스택을 의미한다.

지분 증명 기반 합의 메커니즘을 사용해 지분 보유자가 동결된 자본에 적용되는 일련의 보상과 페널티에서 암호 경제적 보안을 도출한다. 이러한 인센티브 구조는 개별 지분 보유자가 정직한 검증자를 운영하도록 장려하고, 그렇지 않은 지분 보유자를 처벌하며, 네트워크를 공격하는 데 매우 높은 비용을 발생시킨다.

또, 정직한 검증자가 블록을 제안하거나 검증하고, 트랜잭션을 처리하고, 체인 책임자에 대한 의견을 투표하는 방법을 관리하는 프로토콜이 있다. 드물게 여러 블록이 체인 헤드 근처에 같은 위치에 있는 경우, 스테이킹된 이더 잔액에 따라 가중치를 부여한 블록에 투표한 검증자의 수로 측정하여 '가장 무거운' 체인을 구성하는 블록을 선택하는 포크 초이스 메커니즘도 있다.

이러한 다양한 요소들이 모여 합의 메커니즘을 형성한다.

이더리움은 초기에는 작업 증명(PoW; Proof of Work)을 사용했지만, 현재는 지분 증명(PoS; Proof of Stake)을 사용하고 있다. 각 메커니즘은 네트워크의 보안과 효율성을 유지하기 위한 고유한 방식이 있고, 아래에서 좀 더 자세히 알아보겠다.

## 작업 증명(PoW; Proof of Work)

비트코인과 마찬가지로 이더리움도 한때 **작업 증명(PoW)** 기반 합의 프로토콜을 사용했다.

작업 증명 기반 합의는 네트워크의 각 참여자가 복잡한 수학 문제를 해결하여 새로운 블록을 생성하는 방식이다. 이 과정은 '채굴(mining)'이라고 불리며, 성공적으로 문제를 해결한 참여자는 보상으로 이더(ETH)를 받는다.

### 블록 생성

채굴자들은 처리된 거래로 채워진 새로운 블록을 만들기 위해 경쟁한다. 승자는 네트워크의 나머지 부분과 새 블록을 공유하고 새로 발행된 이더를 얻는다. 복잡한 수학 퍼즐을 가장 빨리 풀 수 있는 컴퓨터가 승리하게 되고, 이는 현재 블록과 이전 블록 사이의 암호화 링크를 생성한다. 이 퍼즐을 푸는 것이 "작업 증명" 작업이다. 그런 다음 정식 체인은 채굴을 위해 가장 많은 작업을 수행한 블록 세트를 선택하는 포크 선택 규칙에 의해 결정된다.

### 보안

체인을 속이려면 네트워크 컴퓨팅 성능의 51%가 필요하다는 사실로 인해 네트워크가 안전하게 유지된다. 이를 위해서는 장비와 에너지에 막대한 투자가 필요하다. 당신은 당신이 얻는 것보다 더 많은 돈을 쓸 가능성이 높다.

### 장점

- 보안성: 작업 증명은 공격자가 네트워크를 해킹하기 위해서는 막대한 계산 자원이 필요하므로 높은 보안성을 제공한다.
- 검증의 투명성: 작업 증명 알고리즘은 누구나 검증할 수 있는 투명한 방식이다.

### 단점

- 높은 에너지 소비: 작업 증명은 많은 전력과 자원을 소모한다. CPU, GPU, 채굴기 등 하드웨어를 사용해 암호를 해독하여 채굴하는 방식으로 인해 많은 에너지 및 전력 소모가 요구된다는 점에서 단점이 있다.
- 중앙화 위험: 마이닝 풀의 형성으로 인해 중앙화될 위험이 있다.

## 지분 증명(PoS; Proof of Stake)

이더리움은 현재 **지분 증명(PoS)** 기반 합의 프로토콜을 사용한다.

지분 증명 기반 합의는 네트워크 참여자가 자신의 이더를 '스테이킹'하여 블록 검증에 참여하는 방식이다. 블록 생성자는 스테이킹된 이더의 양과 시간에 따라 선택된다.

그러니까 지분 증명 기반 합의는 채굴기를 통한 연산작업을 수행하는 것이 아니라, 사용자가 소유한 디지털 자산의 지분에 따라 블록을 검증하고 이에 따른 보상을 지급받는 방식이다. 이더리움을 네트워크상에 스테이킹(최소 스테이킹 수량 32ETH)하여 블록을 검증하는 체제로 변한다는 것이다.

### 블록 생성

검증인은 블록을 생성한다. 각 슬롯에서 한 명의 검증인이 무작위로 선택되어 블록 제안자가 된다. 합의 클라이언트는 쌍을 이루는 실행 클라이언트에서 '실행 페이로드'로 트랜잭션 번들을 요청한다. 그들은 이것을 합의 데이터로 포장하여 블록을 형성하고 이더리움 네트워크의 다른 노드로 보낸다.

이 블록 생산은 이더로 보상받는다. 드물지만 단일 슬롯에 여러 개의 가능한 블록이 존재하거나 노드가 서로 다른 시간에 블록에 대해 듣게 되는 경우, 포크 선택 알고리즘은 가장 큰 가중치를 가진 블록을 선택한다(여기서 가중치는 검증자의 이더 잔액에 따라 조정된 검증자 수이다).

### 보안

체인을 제어하려는 공격자가 막대한 양의 ETH를 파괴해야 하기 때문에 지분 증명 시스템은 암호화폐 경제적으로 안전하다. 보상 시스템은 개별 스테이커가 정직하게 행동하도록 장려하고 처벌은 스테이커가 악의적으로 행동하는 것을 방해한다.

### 장점

- 에너지 효율성: 작업 증명에 비해 훨씬 적은 에너지를 소모한다.
- 탈중앙화 촉진: 지분 증명은 더 많은 참여자가 블록 검증에 참여할 수 있도록 장려한다.

### 단점

- 초기 자본 필요: 지분 증명에 참여하려면 초기 스테이킹 자본이 필요하다.
- 새로운 공격 벡터: 지분 증명은 작업 증명과 다른 방식의 공격에 취약할 수 있다.

## 이더리움 2.0: 지분 증명으로의 전환

### 이더리움 2.0이란?

이더리움 2.0은 이더리움 네트워크의 업그레이드 프로젝트로, 작업 증명에서 지분 증명으로의 전환을 주요 목표로 하였다.

디파이(DeFi), NFT 등 새로운 기술을 기반으로 한 프로젝트들이 이더리움 네트워크에서 활성화됨에 따라 이전보다 처리해야 하는 트랜잭션이 증가하게 되었고, 이는 네트워크 혼잡도를 높여 높은 가스 수수료 책정 및 트랜잭션 처리 속도 저하 등 네트워크의 효율성이 떨어지는 문제를 초래하였다. 때문에 이더리움 재단에서는 네트워크의 확장성과 효율성을 높이기 위한 이더리움 2.0을 제시하였다.

### 지분 증명으로의 전환을 통한 기대 효과

- 에너지 소비 감소: 지분 증명은 작업 증명보다 훨씬 적은 에너지를 사용한다.
- 확장성 향상: 지분 증명은 더 많은 트랜잭션을 처리할 수 있다.

이를 토대로 네트워크의 효율성 증대, 더 많은 참여자 유도, 환경 영향 감소 등을 기대할 수 있다.

## 나가며

컴퓨터 과학에서 효과적이라는 의미는 언제나 피할 수 없는 상충관계(trade-off)를 수반한다. 어떠한 알고리즘도 탈중앙화된 합의의 모든 문제를 최적화할 수 없고, 아직까지 정답은 없다. 다만 이러한 고민들은 산업이 발전됨에 따라 계속 논의되고 있고, 그 역사의 흐름 속에 이더리움에서는 이러한 고민과 의사결정을 거쳐왔구나하는 마음으로 이번 모듈을 이해하고 넘어가면 좋을 듯 하다.
