# 온체인 데이터와 ABI

## 들어가며

이더리움은 블록체인 기술의 가장 대표적인 예로, 다양한 탈중앙화 애플리케이션(DApp, 이하 디앱) 등을 구동하는 데 사용된다.

이와 같은 디앱들은 스마트 컨트랙트를 통해 실행되며, 이러한 스마트 컨트랙트의 실행 및 관리에는 온체인 데이터(On-Chain Data)가 핵심적인 역할을 한다.

이번 모듈에서는 JSON RPC를 활용하여 온체인 ABI(Application Binary Interface) 데이터를 조회하는 방법과 온체인 데이터를 이해하는 시간을 가져보도록 하겠다.

## 1. JSON RPC를 활용한 온체인 ABI 데이터 조회

JSON RPC를 사용하면 이더리움 네트워크에서 스마트 계약의 ABI 데이터를 쉽게 조회할 수 있다.

그런데, 이 JSON RPC가 대체 무엇인지, 그리고 ABI란 대체 무엇인지, 먼저 그것들에 대해서 알아보자.

### JSON RPC란?

![image](https://github.com/user-attachments/assets/0e4bc891-04ce-4061-bdce-beb6612708d1)

🔼 출처: https://viblo.asia/p/json-rpc-khi-khong-con-phai-phu-thuoc-vao-web3-07LKXy4pZV4

디앱들이 이더리움 블록체인과 블록체인 데이터를 읽거나 네트워크의 거래를 보내는 등의 상호작용을 하기 위해서는 이더리움 노드에 연결해야 한다. 이를 위해 모든 이더리움 클라이언트는 [JSON-RPC](https://github.com/ethereum/execution-apis) 사양을 구현한다. 따라서 특정 노드나 클라이언트의 구현에 관계없이 애플리케이션이 의존할 수 있는 균일한 메서드의 집합이 존재하게 된다.

JSON RPC는 JSON을 기반으로 한 원격 프로시저 호출(Remote Procedure Call) 프로토콜로서, 클라이언트와 서버 간에 JSON 형식으로 데이터를 주고받을 수 있게 해준다. 이는 이더리움 네트워크에서 다양한 작업을 수행하기 위해 필수적인 도구로 사용된다.

그리고 여기서 RPC란, Remote Procedure Call의 약자이다. 이는 '원격 프로시저 호출'이라는 뜻으로, 언어와 환경 등에 종속되지 않고 서비스 간의 프로시저를 호출하도록 해주는 개념이다.

분산 컴퓨팅 환경에서 많이 사용되며, 프로세스 간 통신의 한 형태로, 클라이언트에서 서버로 필요한 파라미터를 보내어 프로시저를 동작시킨다.

### JSON RPC의 동작 원리

JSON RPC는 클라이언트가 JSON 형식의 요청 메시지를 생성하고, 이를 서버에 전송하여 프로시저를 호출한다.

서버는 해당 요청을 처리하고, 결과를 JSON 형식의 응답 메시지로 변환한다. 이를 통해 클라이언트-서버 간의 프로시저 호출을 간편하게 수행할 수 있다.

동작 방식은 아래와 같다.

#### 1. 요청 작성

- 클라이언트는 JSON-RPC 요청 메시지를 작성한다. 이 요청 메시지는 JSON 객체로 구성되며, 반드시 `jsonrpc`, `method`, `params`, `id` 등의 필드를 포함해야 한다.
  1. `jsonrpc`: 사용하는 JSON-RPC 버전을 나타낸다. 일반적으로 "2.0"을 사용한다.
  2. `method`: 호출하려는 원격 프로시저의 이름을 나타낸다.
  3. `params`: 원격 프로시저에 전달할 매개변수를 포함하는 필드이다.
  4. `id`: 요청을 식별하기 위한 고유한 식별자이다.

#### 2. 요청 전송

- 클라이언트는 요청 메시지를 서버로 전송한다. 일반적으로 HTTP POST 요청을 사용하며 요청 본문에 요청 메시지를 포함한다.

#### 3. 서버 처리

- 서버는 요청을 받아 해당하는 원격 프로시저를 실행한다. 요청 메시지의 `method` 필드에 해당하는 프로시저를 호출하고, `params` 필드의 매개변수를 전달한다.

#### 4. 응답 생성

- 서버는 원격 프로시저의 실행 결과에 따라 응답 메시지를 생성한다. 이 응답 메시지도 JSON 객체로 구성되며, `jsonrpc`, `result`, `error`, `id` 등의 필드를 포함할 수 있다.
  1. `jsonrpc`: 사용하는 JSON-RPC 버전을 나타낸다. 일반적으로 "2.0"을 사용한다.
  2. `result`: 원격 프로시저의 실행 결과를 나타낸다. 성공적인 경우에는 해당 결과가 포함된다.
  3. `error`: 원격 프로시저 실행 중 발생한 오류 정보를 포함한다. 오류가 발생하지 않은 경우에는 이 필드가 생략된다.
  4. `id`: 요청 메시지의 `id`와 동일한 값을 가지며, 요청을 식별하기 위해 사용된다.

#### 5. 응답 전송

- 서버는 응답 메시지를 클라이언트로 전송한다. 일반적으로 HTTP 응답으로 반환되며, 응답 본문에 응답 메시지를 포함시킨다.

#### 6. 응답 처리

- 클라이언트는 서버로부터 받은 응답을 처리한다. 응답 메시지의 `result` 필드에는 원격 프로시저의 실행 결과가 포함되어 있다. `error` 필드가 있는 경우, 오류 정보가 포함된다. 클라이언트는 이를 적절히 처리하고 결과를 활용한다.

### JSON RPC의 요청 형식

요청 형식은 아래와 같다.

```json
{
  "jsonrpc": "2.0",
  "method": "eth_getCode",
  "params": [
    "0xContractAddress", // 스마트 컨트랙트 주소
    "latest" // 최신 블록 번호
  ],
  "id": 1
}
```

### ABI란?

![image](https://github.com/user-attachments/assets/c803b3fa-e5b8-4494-8894-30fc4d037106)

🔼 출처: https://steemit.com/ethereum/@goam/le8r6w6l

ABI(Application Binary Interface)는 이더리움 스마트 컨트랙트와 상호작용하기 위한 표준화된 인터페이스이다.

스마트 컨트랙트는 이더리움 블록체인 상에 배포된 코드로, ABI는 외부 애플리케이션이 이 컨트랙트의 함수를 호출하거나 이벤트를 구독할 수 있도록 정의된 형식이다.

디앱은 스마트 컨트랙트 기반의 웹 서비스이다. 스마트 컨트랙트로 개발한 후 블록체인에 배포하면 스마트 컨트랙트의 어카운트 주소와 ABI 등이 생성된다.

ABI는 스마트 컨트랙트의 함수 및 이벤트를 설명하며, 함수 호출 시 필요한 매개변수와 반환 값의 형식을 포함한다. 스마트 컨트랙트의 바이트코드를 일반 프로그램에서 호출하고 실행시킬 수 있는 정보와 인터페이스가 바로 ABI인 것이다.

ABI는 컨트랙트의 함수와 이벤트를 설명하는 JSON 형식의 인터페이스 명세로, 이를 통해 외부 애플리케이션이나 다른 스마트 컨트랙트가 해당 컨트랙트의 기능을 이해하고 호출할 수 있게 한다.

### ABI 데이터 구조와 형식

ABI는 JSON 배열로 표현되며, 각 요소는 함수나 이벤트를 설명하는 객체이다. 주요 구조는 다음과 같다.

- `type`: 함수(`function`), 생성자(`constructor`), 이벤트(`event`) 등을 나타낸다.
- `name`: 함수나 이벤트의 이름이다.
- `inputs`: 입력 매개변수를 설명하는 객체 배열이다.
- `outputs`: 반환 값을 설명하는 객체 배열이다(함수에만 해당).
- `stateMutability`: 함수의 상태 변경 여부를 나타낸다(`view`, `pure`, `nonpayable`, `payable`).

```json
[
  {
    "type": "function",
    "name": "transfer",
    "inputs": [
      {
        "name": "to",
        "type": "address"
      },
      {
        "name": "value",
        "type": "uint256"
      }
    ],
    "outputs": [
      {
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "nonpayable"
  },
  {
    "type": "event",
    "name": "Transfer",
    "inputs": [
      {
        "indexed": true,
        "name": "from",
        "type": "address"
      },
      {
        "indexed": true,
        "name": "to",
        "type": "address"
      },
      {
        "indexed": false,
        "name": "value",
        "type": "uint256"
      }
    ],
    "anonymous": false
  }
]
```

### ABI 데이터 조회를 위한 JSON RPC 메서드

스마트 컨트랙트의 ABI 데이터는 JSON-RPC 메서드를 통해 조회할 수 있다. 주로 사용되는 메서드는 `eth_getCode`와 `eth_call`이다.

1. `eth_getCode`: 특정 주소의 컨트랙트 코드(=바이트코드)를 조회한다.

   ```json
   // 요청 형식
   {
     "jsonrpc": "2.0",
     "method": "eth_getCode",
     "params": [
       "0xContractAddress", // 스마트 컨트랙트 주소
       "latest" // 최신 블록 번호
     ],
     "id": 1
   }

   // 응답 형식
   {
     "jsonrpc": "2.0",
     "id": 1,
     "result": "0x60806040..." // 스마트 컨트랙트 코드
   }
   ```

2. `eth_call`: 읽기 전용 함수 호출을 통해 데이터를 조회한다(상태를 변경하지 않음).

   ```json
   // 요청 형식
   {
     "jsonrpc": "2.0",
     "method": "eth_call",
     "params": [
       {
         "to": "0xContractAddress", // 스마트 컨트랙트 주소
         "data": "0xFunctionSignatureAndParameters" // 함수 서명 및 매개변수
       },
       "latest" // 최신 블록 번호
     ],
     "id": 1
   }

   // 응답 형식
   {
     "jsonrpc": "2.0",
     "id": 1,
     "result": "0x..." // 함수 호출 결과
   }
   ```

이러한 JSON-RPC 메서드를 사용하여 스마트 컨트랙트와 상호작용할 수 있으며, ABI를 통해 함수와 이벤트를 올바르게 호출하거나 구독할 수 있다.

## 2. 온체인 데이터란?

온체인 데이터는 블록체인 네트워크에 직접 기록되고 저장되는 모든 정보를 의미한다. 이더리움의 경우, 이는 모든 트랜잭션 기록, 스마트 컨트랙트 상호작용, 토큰 전송, 계정 잔액 등을 포함한다. 이 데이터는 공개적이며 변경 불가능하고, 네트워크의 모든 참여자가 접근할 수 있다.

### 온체인 데이터의 중요성 및 활용 사례

#### 중요성

- **투명성**: 모든 거래 내역이 공개적으로 기록되므로 모든 거래와 상호작용을 공개적으로 검증할 수 있다.
- **신뢰성**: 한번 기록된 데이터는 더 이상 변경 불가능하여 조작의 위험이 없다.
- **분석 가능성**: 온체인 데이터는 분석 가능하며, 이를 통해 블록체인 네트워크의 건강 상태를 파악하거나, 특정 패턴을 분석하여 예측 모델을 구축하는 데 활용될 수 있다.
- **보안**: 온체인 데이터는 블록체인 기술의 특성상 높은 보안성을 갖추고 있다. 분산된 노드들이 데이터의 무결성을 검증하므로 해킹이나 데이터 유출의 위험이 적다.

#### 활용 사례

- **시장 분석**: 온체인 데이터를 활용하여 거래소의 유동성, 특정 암호화폐의 거래 빈도 및 거래량 등을 분석할 수 있다. 이를 통해 투자자들은 시장의 움직임을 예측하고 전략을 세울 수 있다.
- **DeFi 분석**: 유동성 풀, 대출 상태, 이자율 등 DeFi 프로토콜의 성과를 모니터링하고, DeFi 플랫폼에서의 모든 거래와 활동이 온체인 데이터로 기록되며, 이를 통해 DeFi 프로젝트의 안정성과 신뢰성을 평가할 수 있다. 또한, 이를 기반으로 한 투자 전략을 세울 수 있다.
- **스마트 계약 모니터링**: 스마트 계약의 실행 내역을 온체인 데이터를 통해 모니터링함으로써 계약이 올바르게 수행되고 있는지 확인할 수 있다. 이는 기업 간의 신뢰 구축 및 계약의 자동화를 촉진한다.
- **사기 탐지**: 비정상적인 거래 패턴을 식별하여 잠재적인 사기를 탐지한다.
- **NFT 추적**: NFT의 소유권 이전과 가치 변동을 추적한다.

### 온체인 데이터의 접근 및 해석 방법

#### 접근 방법

- **블록체인 탐색기**: [이더스캔(Etherscan)](https://etherscan.io/)과 같은 블록체인 탐색기를 사용하면 이더리움 블록체인 상의 모든 거래와 블록 정보를 쉽게 조회할 수 있다. 이 도구들은 사용자에게 거래 내역, 스마트 계약 상호작용, 블록 생성 시간 등의 상세 정보를 제공한다.
- **API**: 다양한 서비스에서 제공하는 API를 통해 온체인 데이터를 프로그래밍 방식으로 가져올 수 있다.
- **노드 운영**: 직접 이더리움 노드를 운영함으로써 네트워크의 모든 데이터를 실시간으로 접근할 수 있다. 이를 통해 더욱 심층적인 분석이 가능해진다.

#### 해석 방법

- **데이터 시각화**: [듄 애널리틱스(Dune Analytics)](https://dune.com/home)와 같은 도구를 사용하여 온체인 데이터를 시각화할 수 있다. 이를 통해 거래 패턴, 스마트 계약 상호작용, 사용자 활동 등의 데이터를 그래프나 차트로 표현하여 쉽게 이해할 수 있다.
- **통계 분석**: 평균, 중앙값, 표준편차 등의 통계적 방법을 사용하여 데이터의 특성을 파악한다.
- **머신러닝**: 대량의 온체인 데이터를 분석하여 패턴을 발견하고 예측 모델을 만든다.
- **컨텍스트 이해**: 온체인 데이터를 해석할 때 시장 상황, 규제 환경 등의 외부 요인을 고려한다.

온체인 데이터는 블록체인 네트워크의 투명성과 신뢰성을 바탕으로 다양한 분석 및 활용이 가능한 중요한 자원이다. 이를 효과적으로 접근하고 해석함으로써, 블록체인 기술의 진정한 가치를 실현할 수 있다.

## 나가며

이번 모듈에서는 JSON RPC와 ABI, 그리고 온체인 데이터가 무엇인지를 알아보고, JSON RPC와 ABI를 통해 온체인 데이터를 조회하는 방법에 대해 살펴보았다.
